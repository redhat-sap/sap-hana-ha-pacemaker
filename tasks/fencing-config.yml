- name: Allow concurrent fencing
  command: pcs property set concurrent-fencing=true
  run_once: true

- name: Set fencing timeout
  command: pcs property set stonith-timeout=900
  run_once: true

- name: Create password script
  copy:
    dest: "{{ sap_hana_ha_pacemaker_fencing_device.password_file }}"
    content: 'echo "{{ sap_hana_ha_pacemaker_fencing_device.pwd }}"'
    mode: 0700
  when:
    - sap_hana_ha_pacemaker_fencing_device.password_file

- name: Enable stonith
  command: pcs property set stonith-enabled=true
  register: stonith
  changed_when: "'error' not in stonith.stdout"
  run_once: true

- name: Set password fragment
  set_fact:
    password_frag: "passwd={{ sap_hana_ha_pacemaker_fencing_device.pwd }}"
  when:
    - not( sap_hana_ha_pacemaker_fencing_device.password_file )

- name: Set password fragment
  set_fact:
    password_frag: "passwd_script={{ sap_hana_ha_pacemaker_fencing_device.password_file }}"
  when:
    - sap_hana_ha_pacemaker_fencing_device.password_file

- name: Create password script
  copy:
    dest: "{{ sap_hana_ha_pacemaker_fencing_device.password_file }}"
    content: 'echo "{{ sap_hana_ha_pacemaker_fencing_device.pwd }}"'
    mode: 0700
  when:
    - sap_hana_ha_pacemaker_fencing_device.password_file
  
- name: Create stonith device without host mapping
  command: >
    pcs stonith create {{ sap_hana_ha_pacemaker_fencing_device.name }} {{ sap_hana_ha_pacemaker_fencing_device.type }}
    ipaddr={{ sap_hana_ha_pacemaker_fencing_device.ip }} login={{ sap_hana_ha_pacemaker_fencing_device.user }} shell_timeout={{ sap_hana_ha_pacemaker_fencing_device.timeout | default('90') }} login_timeout={{ sap_hana_ha_pacemaker_fencing_device.timeout | default('90') }}
    {{ password_frag }} pcmk_host_list={{ sap_hana_ha_pacemaker_fencing_device.pcmk_host_list }} {{ sap_hana_ha_pacemaker_fencing_device.custom_options | default() }} op monitor interval=30
  when:
    - sap_hana_ha_pacemaker_fencing_device.type != "fence_azure_arm"
    - not( sap_hana_ha_pacemaker_fencing_device.pcmk_host_list is undefined )
  register: stonith_device
  changed_when: "'error' not in stonith_device.stdout"
  run_once: true

- name: Create stonith device with host mapping
  command: >
    pcs stonith create {{ sap_hana_ha_pacemaker_fencing_device.name }} {{ sap_hana_ha_pacemaker_fencing_device.type }}
    ipaddr={{ sap_hana_ha_pacemaker_fencing_device.ip }} login={{ sap_hana_ha_pacemaker_fencing_device.user }} shell_timeout={{ sap_hana_ha_pacemaker_fencing_device.timeout | default('90') }} login_timeout={{ sap_hana_ha_pacemaker_fencing_device.timeout  | default('90')}}
    {{ password_frag }} pcmk_host_map={{ sap_hana_ha_pacemaker_fencing_device.pcmk_host_map }} {{ sap_hana_ha_pacemaker_fencing_device.custom_options | default()  }} op monitor interval=30
  when:
    - sap_hana_ha_pacemaker_fencing_device.type != "fence_azure_arm"
    - not( sap_hana_ha_pacemaker_fencing_device.pcmk_host_map is undefined )
  register: stonith_device
  changed_when: "'error' not in stonith_device.stdout"
  run_once: true